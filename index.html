<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกรายรับรายจ่าย</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="icon.png " type="image/x-icon">
</head>
<body>
    <!-- Header -->
    <header class="navbar-custom py-3">
        <div class="container">
            <h1 class="text-center text-white mb-0">ระบบบันทึกรายรับรายจ่าย</h1>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">

            <div class="col-lg-4 mb-4" data-aos="zoom-in" data-aos-delay="100">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">บันทึกรายการใหม่</h5>
                    </div>
                    <div class="card-body">
                        <form id="transaction-form">
                            <div class="mb-3">
                                <label class="form-label">ประเภทรายการ</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="type" id="income-radio" value="รายรับ" checked>
                                    <label class="form-check-label" for="income-radio">รายรับ</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="type" id="expense-radio" value="รายจ่าย">
                                    <label class="form-check-label" for="expense-radio">รายจ่าย</label>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="date" class="form-label">วันที่</label>
                                <input type="date" class="form-control" id="date" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="amount" class="form-label">จำนวนเงิน (บาท)</label>
                                <input type="number" class="form-control" id="amount" min="0" step="0.01" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="category" class="form-label">หมวดหมู่</label>
                                <select class="form-select" id="category" required>
                                    <option value="" selected disabled>เลือกหมวดหมู่</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label for="note" class="form-label">หมายเหตุ</label>
                                <textarea class="form-control" id="note" rows="3"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary w-100">บันทึกรายการ</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-lg-8" data-aos="zoom-in" data-aos-delay="200">
                <div class="card mb-4">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" >สรุปรายรับรายจ่าย</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-success" id="export-excel">ส่งออก Excel</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="summary-card bg-light">
                                    <h6>รายรับทั้งหมด</h6>
                                    <h3 class="income-total" id="total-income" data-aos="zoom-in" data-aos-delay="300">฿0.00</h3>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3 mb-md-0">
                                <div class="summary-card bg-light">
                                    <h6>รายจ่ายทั้งหมด</h6>
                                    <h3 class="expense-total" id="total-expense" data-aos="zoom-in" data-aos-delay="400">฿0.00</h3>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="summary-card bg-light">
                                    <h6>คงเหลือ</h6>
                                    <h3 class="balance-total" id="balance"data-aos="zoom-in" data-aos-delay="500">฿0.00</h3>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-primary active-tab" id="all-transactions-btn">รายการทั้งหมด</button>
                                        <button class="btn btn-sm btn-outline-primary" id="income-tab-btn">รายรับ</button>
                                        <button class="btn btn-sm btn-outline-primary" id="expense-tab-btn">รายจ่าย</button>
                                        
                                    </div>
                                    <div class="period-filter">
                                        <select class="form-select form-select-sm" id="period-selector">
                                            <option value="month">รายเดือน</option>
                                            <option value="year">รายปี</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="date-filter mb-3">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <select class="form-select" id="month-selector">
                                                <option value="1">มกราคม</option>
                                                <option value="2">กุมภาพันธ์</option>
                                                <option value="3">มีนาคม</option>
                                                <option value="4">เมษายน</option>
                                                <option value="5">พฤษภาคม</option>
                                                <option value="6">มิถุนายน</option>
                                                <option value="7">กรกฎาคม</option>
                                                <option value="8">สิงหาคม</option>
                                                <option value="9">กันยายน</option>
                                                <option value="10">ตุลาคม</option>
                                                <option value="11">พฤศจิกายน</option>
                                                <option value="12">ธันวาคม</option>
                                            </select>
                                        </div>
                                        <div class="col-md-3">
                                            <select class="form-select" id="year-selector">
                                                <!-- Will be populated with JS -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Charts Section -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-4 mb-md-0">
                                <h6>รายจ่ายตามหมวดหมู่</h6>
                                <div class="chart-container" style="position: relative; height: 200px;">
                                    <canvas id="expense-chart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>รายรับตามหมวดหมู่</h6>
                                <div class="chart-container" style="position: relative; height: 200px;">
                                    <canvas id="income-chart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Transactions Table -->
                        <div class="transactions-table mt-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6>รายการทั้งหมด</h6>
                                <div class="input-group input-group-sm" style="max-width: 300px;">
                                    <input type="text" class="form-control" id="search-transactions" placeholder="ค้นหารายการ...">
                                </div>
                            </div>
                            
                            <div class="table-responsive">
                                <table class="table table-hover" id="transactions-table">
                                    <thead>
                                        <tr>
                                            <th>วันที่</th>
                                            <th>ประเภท</th>
                                            <th>หมวดหมู่</th>
                                            <th>จำนวนเงิน</th>
                                            <th>หมายเหตุ</th>
                                            <th>จัดการ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transactions-list">
                                        <!-- Will be populated with JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">ตั้งค่าระบบ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-success">หมวดหมู่รายรับ</h6>
                            <div class="mb-3" id="income-categories-list">
                                <!-- Will be populated with JS -->
                            </div>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="new-income-category" placeholder="เพิ่มหมวดหมู่ใหม่">
                                <button class="btn btn-success" type="button" id="add-income-category">เพิ่ม</button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-danger">หมวดหมู่รายจ่าย</h6>
                            <div class="mb-3" id="expense-categories-list">
                                <!-- Will be populated with JS -->
                            </div>
                            <div class="input-group mb-3">
                                <input type="text" class="form-control" id="new-expense-category" placeholder="เพิ่มหมวดหมู่ใหม่">
                                <button class="btn btn-danger" type="button" id="add-expense-category">เพิ่ม</button>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>การจัดการข้อมูล</h6>
                            <div class="d-flex justify-content-between mt-3">
                                <button class="btn btn-primary" id="backup-data">สำรองข้อมูลทั้งหมด</button>
                                <button class="btn btn-secondary" id="import-data">นำเข้าข้อมูล</button>
                                <button class="btn btn-warning" id="reset-category-default">รีเซ็ตหมวดหมู่เป็นค่าเริ่มต้น</button>
                                <button class="btn btn-danger" id="reset-all-data">ล้างข้อมูลทั้งหมด</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">แก้ไขรายการ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-transaction-form">
                        <input type="hidden" id="edit-transaction-id">
                        <div class="mb-3">
                            <label class="form-label">ประเภทรายการ</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="edit-type" id="edit-income-radio" value="รายรับ">
                                <label class="form-check-label" for="edit-income-radio">รายรับ</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="edit-type" id="edit-expense-radio" value="รายจ่าย">
                                <label class="form-check-label" for="edit-expense-radio">รายจ่าย</label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-date" class="form-label">วันที่</label>
                            <input type="date" class="form-control" id="edit-date" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-amount" class="form-label">จำนวนเงิน (บาท)</label>
                            <input type="number" class="form-control" id="edit-amount" min="0" step="0.01" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-category" class="form-label">หมวดหมู่</label>
                            <select class="form-select" id="edit-category" required>
                                <!-- Will be populated with JS -->
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-note" class="form-label">หมายเหตุ</label>
                            <textarea class="form-control" id="edit-note" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="save-edit-transaction">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <button class="btn btn-primary rounded-circle position-fixed" style="bottom: 20px; right: 20px; width: 50px; height: 50px;" data-bs-toggle="modal" data-bs-target="#settingsModal">
        <i class="bi bi-gear"></i>
    </button>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        AOS.init({
            duration: 1000,
            easing: 'ease',
            once: true,
        });

        document.addEventListener('DOMContentLoaded', function() {
            // Default categories
            const defaultCategories = {
                income: ['เงินเดือน', 'โบนัส', 'เงินพิเศษ', 'ดอกเบี้ย/เงินปันผล', 'อื่นๆ (รายรับ)'],
                expense: ['อาหาร', 'ที่พัก', 'เดินทาง', 'สาธารณูปโภค', 'ช้อปปิ้ง', 'ความบันเทิง', 'สุขภาพ', 'อื่นๆ (รายจ่าย)']
            };
            
            // Load or initialize categories
            let categories = JSON.parse(localStorage.getItem('expenseTrackerCategories')) || defaultCategories;
            if (!categories.income || !categories.expense) {
                categories = defaultCategories;
                localStorage.setItem('expenseTrackerCategories', JSON.stringify(categories));
            }
            
            // Load transactions or initialize empty array
            let transactions = JSON.parse(localStorage.getItem('expenseTrackerTransactions')) || [];
            
            // Initialize charts
            let expenseChart, incomeChart;
            
            // Initialize modals
            const settingsModal = new bootstrap.Modal(document.getElementById('settingsModal'));
            const editTransactionModal = new bootstrap.Modal(document.getElementById('editTransactionModal'));
            
            // Populate category dropdowns
            function populateCategoryDropdowns() {
                const categorySelect = document.getElementById('category');
                const editCategorySelect = document.getElementById('edit-category');
                
                // Clear existing options
                categorySelect.innerHTML = '<option value="" selected disabled>เลือกหมวดหมู่</option>';
                editCategorySelect.innerHTML = '';
                
                // Get selected type
                const isIncomeSelected = document.getElementById('income-radio').checked;
                const relevantCategories = isIncomeSelected ? categories.income : categories.expense;
                
                // Add options
                relevantCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option.cloneNode(true));
                    editCategorySelect.appendChild(option);
                });
            }
            
            // Update categories in settings modal
            function updateCategoriesDisplay() {
                const incomeList = document.getElementById('income-categories-list');
                const expenseList = document.getElementById('expense-categories-list');
                
                incomeList.innerHTML = '';
                expenseList.innerHTML = '';
                
                categories.income.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'd-flex justify-content-between align-items-center mb-2';
                    item.innerHTML = `
                        <span>${category}</span>
                        <button class="btn btn-sm btn-outline-danger delete-category" data-type="income" data-category="${category}">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    incomeList.appendChild(item);
                });
                
                categories.expense.forEach(category => {
                    const item = document.createElement('div');
                    item.className = 'd-flex justify-content-between align-items-center mb-2';
                    item.innerHTML = `
                        <span>${category}</span>
                        <button class="btn btn-sm btn-outline-danger delete-category" data-type="expense" data-category="${category}">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    expenseList.appendChild(item);
                });
                
                // Add event listeners to delete buttons
                document.querySelectorAll('.delete-category').forEach(button => {
                    button.addEventListener('click', function() {
                        const type = this.getAttribute('data-type');
                        const categoryToDelete = this.getAttribute('data-category');
                        
                        // Remove from array
                        categories[type] = categories[type].filter(cat => cat !== categoryToDelete);
                        
                        // Save to localStorage
                        localStorage.setItem('expenseTrackerCategories', JSON.stringify(categories));
                        
                        // Update display
                        updateCategoriesDisplay();
                        populateCategoryDropdowns();
                    });
                });
            }
            
            // Format amount for display
            function formatAmount(amount, isIncome = true) {
                const formattedAmount = parseFloat(amount).toLocaleString('th-TH', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });
                
                return isIncome ? `฿${formattedAmount}` : `-฿${formattedAmount}`;
            }
            
            // Format date for display
            function formatDateForDisplay(dateString) {
                const date = new Date(dateString);
                const day = date.getDate();
                const month = date.getMonth() + 1;
                const year = date.getFullYear() + 543; // Convert to Buddhist Era
                
                return `${day < 10 ? '0' + day : day}/${month < 10 ? '0' + month : month}/${year}`;
            }
            
            // Update transactions table
            function updateTransactionsTable(filterType = 'all') {
                const tbody = document.getElementById('transactions-list');
                tbody.innerHTML = '';
                
                // Get selected month and year
                const selectedMonth = parseInt(document.getElementById('month-selector').value);
                const selectedYear = parseInt(document.getElementById('year-selector').value);
                
                // Filter transactions by month, year and type
                let filteredTransactions = transactions.filter(transaction => {
                    const transDate = new Date(transaction.date);
                    const transMonth = transDate.getMonth() + 1;
                    const transYear = transDate.getFullYear();
                    
                    if (filterType === 'all') {
                        return transMonth === selectedMonth && transYear === selectedYear;
                    } else {
                        return transMonth === selectedMonth && 
                               transYear === selectedYear && 
                               transaction.type === filterType;
                    }
                });
                
                // Sort by date (newest first)
                filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Create table rows
                filteredTransactions.forEach((transaction, index) => {
                    const row = document.createElement('tr');
                    row.className = transaction.type === 'รายรับ' ? 'income-row' : 'expense-row';
                    
                    const formattedDate = formatDateForDisplay(transaction.date);
                    const formattedAmount = formatAmount(transaction.amount, transaction.type === 'รายรับ');
                    const amountColor = transaction.type === 'รายรับ' ? 'text-success' : 'text-danger';
                    
                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>
                            <span class="badge ${transaction.type === 'รายรับ' ? 'bg-success' : 'bg-danger'}">
                                ${transaction.type}
                            </span>
                        </td>
                        <td>${transaction.category}</td>
                        <td class="${amountColor} fw-bold">${formattedAmount}</td>
                        <td>${transaction.note || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary edit-transaction" data-index="${index}">
                                แก้ไข
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-transaction" data-index="${index}">
                                ลบ
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Add event listeners
                document.querySelectorAll('.edit-transaction').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        const transaction = filteredTransactions[index];
                        
                        // Populate edit form
                        document.getElementById('edit-transaction-id').value = transaction.id;
                        document.getElementById(transaction.type === 'รายรับ' ? 'edit-income-radio' : 'edit-expense-radio').checked = true;
                        document.getElementById('edit-date').value = transaction.date;
                        document.getElementById('edit-amount').value = transaction.amount;
                        
                        // Update category dropdown based on type
                        const editCategorySelect = document.getElementById('edit-category');
                        editCategorySelect.innerHTML = '';
                        
                        const relevantCategories = transaction.type === 'รายรับ' ? categories.income : categories.expense;
                        relevantCategories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category;
                            option.textContent = category;
                            if (category === transaction.category) {
                                option.selected = true;
                            }
                            editCategorySelect.appendChild(option);
                        });
                        
                        document.getElementById('edit-note').value = transaction.note || '';
                        
                        // Show modal
                        editTransactionModal.show();
                    });
                });
                
                document.querySelectorAll('.delete-transaction').forEach(button => {
                    button.addEventListener('click', function() {
                        if (confirm('คุณแน่ใจหรือไม่ที่จะลบรายการนี้?')) {
                            const index = parseInt(this.getAttribute('data-index'));
                            const transactionId = filteredTransactions[index].id;
                            
                            // Remove from array
                            transactions = transactions.filter(t => t.id !== transactionId);
                            
                            // Save to localStorage
                            localStorage.setItem('expenseTrackerTransactions', JSON.stringify(transactions));
                            
                            // Update UI
                            updateTransactionsTable(filterType);
                            updateSummary();
                            updateCharts();
                        }
                    });
                });
            }
// Update summary values
function updateSummary() {
                // Get selected month and year
                const selectedMonth = parseInt(document.getElementById('month-selector').value);
                const selectedYear = parseInt(document.getElementById('year-selector').value);
                
                // Filter transactions for the selected month and year
                const filteredTransactions = transactions.filter(transaction => {
                    const transDate = new Date(transaction.date);
                    const transMonth = transDate.getMonth() + 1;
                    const transYear = transDate.getFullYear();
                    
                    return transMonth === selectedMonth && transYear === selectedYear;
                });
                
                // Calculate totals
                let totalIncome = 0;
                let totalExpense = 0;
                
                filteredTransactions.forEach(transaction => {
                    if (transaction.type === 'รายรับ') {
                        totalIncome += parseFloat(transaction.amount);
                    } else {
                        totalExpense += parseFloat(transaction.amount);
                    }
                });
                
                const balance = totalIncome - totalExpense;
                
                // Update UI
                document.getElementById('total-income').textContent = formatAmount(totalIncome, true);
                document.getElementById('total-expense').textContent = formatAmount(totalExpense, false);
                document.getElementById('balance').textContent = formatAmount(Math.abs(balance), balance >= 0);
                
                // Change balance color based on value
                const balanceElement = document.getElementById('balance');
                if (balance < 0) {
                    balanceElement.classList.remove('balance-total', 'text-success');
                    balanceElement.classList.add('text-danger');
                } else {
                    balanceElement.classList.remove('text-danger');
                    balanceElement.classList.add('balance-total');
                }
            }
            
            // Initialize and update charts
            function updateCharts() {
                // Get selected month and year
                const selectedMonth = parseInt(document.getElementById('month-selector').value);
                const selectedYear = parseInt(document.getElementById('year-selector').value);
                
                // Filter transactions for the selected month and year
                const filteredTransactions = transactions.filter(transaction => {
                    const transDate = new Date(transaction.date);
                    const transMonth = transDate.getMonth() + 1;
                    const transYear = transDate.getFullYear();
                    
                    return transMonth === selectedMonth && transYear === selectedYear;
                });
                
                // Prepare data for expense chart
                const expenseData = {};
                const expenseTransactions = filteredTransactions.filter(t => t.type === 'รายจ่าย');
                
                categories.expense.forEach(category => {
                    expenseData[category] = 0;
                });
                
                expenseTransactions.forEach(transaction => {
                    expenseData[transaction.category] = (expenseData[transaction.category] || 0) + parseFloat(transaction.amount);
                });
                
                // Prepare data for income chart
                const incomeData = {};
                const incomeTransactions = filteredTransactions.filter(t => t.type === 'รายรับ');
                
                categories.income.forEach(category => {
                    incomeData[category] = 0;
                });
                
                incomeTransactions.forEach(transaction => {
                    incomeData[transaction.category] = (incomeData[transaction.category] || 0) + parseFloat(transaction.amount);
                });
                
                // Colors for charts
                const expenseColors = [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#C9CBCF', '#7B68EE', '#00FA9A', '#FF6347'
                ];
                
                const incomeColors = [
                    '#4BC0C0', '#36A2EB', '#FFCE56', '#FF6384', '#9966FF',
                    '#FF9F40', '#C9CBCF', '#7B68EE', '#00FA9A', '#FF6347'
                ];
                
                // Create or update expense chart
                const expenseCtx = document.getElementById('expense-chart').getContext('2d');
                
                if (expenseChart) {
                    expenseChart.destroy();
                }
                
                expenseChart = new Chart(expenseCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(expenseData).filter(category => expenseData[category] > 0),
                        datasets: [{
                            data: Object.values(expenseData).filter(amount => amount > 0),
                            backgroundColor: expenseColors.slice(0, Object.keys(expenseData).filter(category => expenseData[category] > 0).length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Create or update income chart
                const incomeCtx = document.getElementById('income-chart').getContext('2d');
                
                if (incomeChart) {
                    incomeChart.destroy();
                }
                
                incomeChart = new Chart(incomeCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(incomeData).filter(category => incomeData[category] > 0),
                        datasets: [{
                            data: Object.values(incomeData).filter(amount => amount > 0),
                            backgroundColor: incomeColors.slice(0, Object.keys(incomeData).filter(category => incomeData[category] > 0).length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    font: {
                                        size: 12
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Export to Excel (CSV format)
            function exportToExcel() {
                // Get selected month and year
                const selectedMonth = parseInt(document.getElementById('month-selector').value);
                const selectedYear = parseInt(document.getElementById('year-selector').value);
                
                // Filter transactions
                const filteredTransactions = transactions.filter(transaction => {
                    const transDate = new Date(transaction.date);
                    const transMonth = transDate.getMonth() + 1;
                    const transYear = transDate.getFullYear();
                    
                    return transMonth === selectedMonth && transYear === selectedYear;
                });
                
                // Sort by date
                filteredTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Create CSV content with UTF-8 BOM
                // Add UTF-8 BOM (Byte Order Mark) at the beginning of the file
                let csvContent = '\uFEFF' + 'วันที่,ประเภท,หมวดหมู่,จำนวนเงิน,หมายเหตุ\n';
                
                filteredTransactions.forEach(transaction => {
                    const formattedDate = formatDateForDisplay(transaction.date);
                    const amount = transaction.type === 'รายรับ' ? 
                                    transaction.amount : 
                                    `-${transaction.amount}`;
                    
                    // Escape quotes in note to prevent CSV issues
                    const safeNote = (transaction.note || '').replace(/"/g, '""');
                    
                    csvContent += `${formattedDate},${transaction.type},${transaction.category},${amount},"${safeNote}"\n`;
                });
                
                // Create download link
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                
                // Get month name in Thai
                const monthNames = [
                    'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                    'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
                ];
                
                // Set file name
                const fileName = `รายรับรายจ่าย_${monthNames[selectedMonth-1]}_${selectedYear}.csv`;
                
                link.href = url;
                link.setAttribute('download', fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // Populate year dropdown
            function populateYearDropdown() {
                const yearSelector = document.getElementById('year-selector');
                yearSelector.innerHTML = '';
                
                const currentYear = new Date().getFullYear();
                
                // Add options for current year and 5 years before and after
                for (let year = currentYear - 5; year <= currentYear + 5; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    
                    if (year === currentYear) {
                        option.selected = true;
                    }
                    
                    yearSelector.appendChild(option);
                }
            }
            
            // Initialize app
            function initializeApp() {
                // Populate year dropdown
                populateYearDropdown();
                
                // Set current month in dropdown
                const currentMonth = new Date().getMonth() + 1;
                document.getElementById('month-selector').value = currentMonth;
                
                // Initialize category dropdowns
                populateCategoryDropdowns();
                
                // Initialize categories display in settings
                updateCategoriesDisplay();
                
                // Update transactions table
                updateTransactionsTable();
                
                // Update summary
                updateSummary();
                
                // Initialize charts
                updateCharts();
                
                // Add event listeners
                setupEventListeners();
            }
            
            // Setup event listeners
            function setupEventListeners() {
                // Form submission
                document.getElementById('transaction-form').addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const type = document.getElementById('income-radio').checked ? 'รายรับ' : 'รายจ่าย';
                    const date = document.getElementById('date').value;
                    const amount = document.getElementById('amount').value;
                    const category = document.getElementById('category').value;
                    const note = document.getElementById('note').value;
                    
                    // Validate
                    if (!date || !amount || !category) {
                        alert('กรุณากรอกข้อมูลให้ครบถ้วน');
                        return;
                    }
                    
                    // Create new transaction object
                    const newTransaction = {
                        id: Date.now().toString(), // Use timestamp as unique ID
                        type: type,
                        date: date,
                        amount: parseFloat(amount),
                        category: category,
                        note: note
                    };
                    
                    // Add to transactions array
                    transactions.push(newTransaction);
                    
                    // Save to localStorage
                    localStorage.setItem('expenseTrackerTransactions', JSON.stringify(transactions));
                    
                    // Reset form
                    this.reset();
                    document.getElementById('income-radio').checked = true;
                    document.getElementById('date').value = new Date().toISOString().split('T')[0];
                    populateCategoryDropdowns();
                    
                    // Update UI
                    updateTransactionsTable();
                    updateSummary();
                    updateCharts();
                    
                    alert('บันทึกรายการเรียบร้อยแล้ว');
                });
                
                // Radio buttons change event
                document.getElementById('income-radio').addEventListener('change', populateCategoryDropdowns);
                document.getElementById('expense-radio').addEventListener('change', populateCategoryDropdowns);
                
                // Edit form radio buttons
                document.getElementById('edit-income-radio').addEventListener('change', function() {
                    const editCategorySelect = document.getElementById('edit-category');
                    editCategorySelect.innerHTML = '';
                    
                    categories.income.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        editCategorySelect.appendChild(option);
                    });
                });
                
                document.getElementById('edit-expense-radio').addEventListener('change', function() {
                    const editCategorySelect = document.getElementById('edit-category');
                    editCategorySelect.innerHTML = '';
                    
                    categories.expense.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        editCategorySelect.appendChild(option);
                    });
                });
                
                // Save edited transaction
                document.getElementById('save-edit-transaction').addEventListener('click', function() {
                    const id = document.getElementById('edit-transaction-id').value;
                    const type = document.getElementById('edit-income-radio').checked ? 'รายรับ' : 'รายจ่าย';
                    const date = document.getElementById('edit-date').value;
                    const amount = document.getElementById('edit-amount').value;
                    const category = document.getElementById('edit-category').value;
                    const note = document.getElementById('edit-note').value;
                    
                    // Find transaction index
                    const transactionIndex = transactions.findIndex(t => t.id === id);
                    
                    if (transactionIndex !== -1) {
                        // Update transaction
                        transactions[transactionIndex] = {
                            id: id,
                            type: type,
                            date: date,
                            amount: parseFloat(amount),
                            category: category,
                            note: note
                        };
                        
                        // Save to localStorage
                        localStorage.setItem('expenseTrackerTransactions', JSON.stringify(transactions));
                        
                        // Update UI
                        updateTransactionsTable();
                        updateSummary();
                        updateCharts();
                        
                        // Close modal
                        editTransactionModal.hide();
                        
                        alert('แก้ไขรายการเรียบร้อยแล้ว');
                    }
                });
                
                // Month and year selectors change event
                document.getElementById('month-selector').addEventListener('change', function() {
                    updateTransactionsTable();
                    updateSummary();
                    updateCharts();
                });
                
                document.getElementById('year-selector').addEventListener('change', function() {
                    updateTransactionsTable();
                    updateSummary();
                    updateCharts();
                });
                
                // Transaction tabs
                document.getElementById('all-transactions-btn').addEventListener('click', function() {
                    document.getElementById('all-transactions-btn').classList.add('active-tab');
                    document.getElementById('income-tab-btn').classList.remove('active-tab');
                    document.getElementById('expense-tab-btn').classList.remove('active-tab');
                    
                    document.getElementById('all-transactions-btn').classList.remove('btn-outline-primary');
                    document.getElementById('income-tab-btn').classList.add('btn-outline-primary');
                    document.getElementById('expense-tab-btn').classList.add('btn-outline-primary');
                    
                    updateTransactionsTable('all');
                });
                
                document.getElementById('income-tab-btn').addEventListener('click', function() {
                    document.getElementById('all-transactions-btn').classList.remove('active-tab');
                    document.getElementById('income-tab-btn').classList.add('active-tab');
                    document.getElementById('expense-tab-btn').classList.remove('active-tab');
                    
                    document.getElementById('all-transactions-btn').classList.add('btn-outline-primary');
                    document.getElementById('income-tab-btn').classList.remove('btn-outline-primary');
                    document.getElementById('expense-tab-btn').classList.add('btn-outline-primary');
                    
                    updateTransactionsTable('รายรับ');
                });
                
                document.getElementById('expense-tab-btn').addEventListener('click', function() {
                    document.getElementById('all-transactions-btn').classList.remove('active-tab');
                    document.getElementById('income-tab-btn').classList.remove('active-tab');
                    document.getElementById('expense-tab-btn').classList.add('active-tab');
                    
                    document.getElementById('all-transactions-btn').classList.add('btn-outline-primary');
                    document.getElementById('income-tab-btn').classList.add('btn-outline-primary');
                    document.getElementById('expense-tab-btn').classList.remove('btn-outline-primary');
                    
                    updateTransactionsTable('รายจ่าย');
                });
                
                // Export buttons
                document.getElementById('export-excel').addEventListener('click', exportToExcel);

                
                // Add new income category
                document.getElementById('add-income-category').addEventListener('click', function() {
                    const newCategory = document.getElementById('new-income-category').value.trim();
                    
                    if (newCategory && !categories.income.includes(newCategory)) {
                        categories.income.push(newCategory);
                        localStorage.setItem('expenseTrackerCategories', JSON.stringify(categories));
                        
                        document.getElementById('new-income-category').value = '';
                        updateCategoriesDisplay();
                        populateCategoryDropdowns();
                    } else if (categories.income.includes(newCategory)) {
                        alert('หมวดหมู่นี้มีอยู่แล้ว');
                    }
                });
                
                // Add new expense category
                document.getElementById('add-expense-category').addEventListener('click', function() {
                    const newCategory = document.getElementById('new-expense-category').value.trim();
                    
                    if (newCategory && !categories.expense.includes(newCategory)) {
                        categories.expense.push(newCategory);
                        localStorage.setItem('expenseTrackerCategories', JSON.stringify(categories));
                        
                        document.getElementById('new-expense-category').value = '';
                        updateCategoriesDisplay();
                        populateCategoryDropdowns();
                    } else if (categories.expense.includes(newCategory)) {
                        alert('หมวดหมู่นี้มีอยู่แล้ว');
                    }
                });
                
                // Backup data
                document.getElementById('backup-data').addEventListener('click', function() {
                    const backupData = {
                        categories: categories,
                        transactions: transactions
                    };
                    
                    const blob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    const now = new Date();
                    const formattedDate = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')}`;
                    
                    link.href = url;
                    link.setAttribute('download', `expense-tracker-backup-${formattedDate}.json`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
                
                // Import data
                document.getElementById('import-data').addEventListener('click', function() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'application/json';
                    
                    input.onchange = e => {
                        const file = e.target.files[0];
                        
                        if (file) {
                            const reader = new FileReader();
                            
                            reader.onload = function(event) {
                                try {
                                    const importedData = JSON.parse(event.target.result);
                                    
                                    if (importedData.categories && importedData.transactions) {
                                        if (confirm('นำเข้าข้อมูลจะทับข้อมูลเดิมทั้งหมด คุณแน่ใจหรือไม่?')) {
                                            categories = importedData.categories;
                                            transactions = importedData.transactions;
                                            
                                            localStorage.setItem('expenseTrackerCategories', JSON.stringify(categories));
                                            localStorage.setItem('expenseTrackerTransactions', JSON.stringify(transactions));
                                            
                                            // Refresh UI
                                            initializeApp();
                                            
                                            alert('นำเข้าข้อมูลเรียบร้อยแล้ว');
                                            settingsModal.hide();
                                        }
                                    } else {
                                        alert('รูปแบบไฟล์ไม่ถูกต้อง');
                                    }
                                } catch (error) {
                                    alert('เกิดข้อผิดพลาดในการนำเข้าข้อมูล: ' + error.message);
                                }
                            };
                            
                            reader.readAsText(file);
                        }
                    };
                    
                    input.click();
                });
                
                // Reset to default categories
                document.getElementById('reset-category-default').addEventListener('click', function() {
                    if (confirm('คุณแน่ใจหรือไม่ที่จะรีเซ็ตหมวดหมู่เป็นค่าเริ่มต้น?')) {
                        categories = JSON.parse(JSON.stringify(defaultCategories));
                        localStorage.setItem('expenseTrackerCategories', JSON.stringify(categories));
                        
                        updateCategoriesDisplay();
                        populateCategoryDropdowns();
                        alert('รีเซ็ตหมวดหมู่เรียบร้อยแล้ว');
                    }
                });
                
                // Reset all data
                document.getElementById('reset-all-data').addEventListener('click', function() {
                    if (confirm('คุณแน่ใจหรือไม่ที่จะล้างข้อมูลทั้งหมด? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                        localStorage.removeItem('expenseTrackerTransactions');
                        localStorage.removeItem('expenseTrackerCategories');
                        
                        transactions = [];
                        categories = JSON.parse(JSON.stringify(defaultCategories));
                        
                        localStorage.setItem('expenseTrackerCategories', JSON.stringify(categories));
                        
                        // Refresh UI
                        initializeApp();
                        
                        alert('ล้างข้อมูลทั้งหมดเรียบร้อยแล้ว');
                        settingsModal.hide();
                    }
                });
                
                // Search transactions
                document.getElementById('search-transactions').addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#transactions-list tr');
                    
                    rows.forEach(row => {
                        const text = row.textContent.toLowerCase();
                        if (text.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
                
                // Set today's date in the input field
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
            }
            
            // Initialize the app when the DOM is loaded
            initializeApp();
        });
    </script>
</body>
</html>